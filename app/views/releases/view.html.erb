<%= stylesheet_link_tag "releases", :media => "all" %>

<section>
<div class="pr_container container-fluid">
  <% Settings.projects.each do |project| %>
    <div class="pr_row row">
      <div class="pr_column col-sm-2">
          <div class="pr_heading row">
            <div><%= project.name %></div>
          </div>
          <div class="pr_data row">
              <ul >
              <% list_pull_requests( current_user , project.ref ).each_with_index do |pr,i| %>
                <% if i == 0 %><br><span class="pr_bold">Open Pull Requests</span><% end %>
                <li> <%= pr['title'] %> </li>
                <% end %>
              </ul>
          </div>

      </div>
      <% if project.environments %>
        <% project.environments.each do |environment| %>
          <% data =  list_workflow_last_run( current_user , project.ref , environment.deployment_workflow , environment.deployment_branch ) %>
          <div class="col-sm-3 <%= map_conclusion_to_div( data ) %>" >
            <div class="row">
              <div class="pr_heading" style="padding-left: 10%; width: 90%; " > <%= environment.name %>  </div>
              <div class="pr_icon"   style="width: 10%; " > <%= user_role( current_user, project.ref ) %> </div>
            </div>
            <%if data%>
                <div class="pr_heading_2 row"> Deployment <%= map_conclusion_to_text( data ) %>   </div>
                <div class="pr_data_center row"><%= first_line( data['head_commit']['message'] ) %> </div>
                <div class="pr_data_center row"> <%= timestamp_conversion( data['created_at'] )%>   </div>
                <div class="pr_data_center row"> by <%= data['head_commit']['author']['name'] %> </div>
                <div class="pr_text_row row"> <%= data['description'] %> </div>
                <% if map_conclusion_to_text( data ) == 'Error' %>
                  <br>
                  <% data2 = list_workflow_last_successful_run(  current_user , project.ref , environment.deployment_workflow , environment.deployment_branch )%>
                  <div class="pr_text_row row"> <%= first_line( data2['head_commit']['message'] ) %> </div>
                  <div class="pr_data_center row"> Last Successful Run </div>
                  <div class="pr_data_center row"> <%= timestamp_conversion( data2['created_at'] ) %> </div>
                  <div class="pr_data_center row"> by <%= data2['head_commit']['author']['name'] %> </div>


                <% end %>
            <% end %>
          </div>
        <% end %>
      <% end %>
    </div>
  <% end %>
</div>
</section>
